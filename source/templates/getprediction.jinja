<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heart Disease Checker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prediction.css') }}" />
</head>
<body>
    <div class="background-pattern"></div>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo">
                    <svg class="heart-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                    </svg>
                    <h1>Heart Disease Checker</h1>
                </div>
                <p class="subtitle">Advanced Cardiovascular Risk Assessment</p>
            </div>
        </div>

        <div class="login-section">
            <div class="login-container">
                <input type="text" placeholder="Username" id="username" class="modern-input" />
                <input type="password" placeholder="Password" id="password" class="modern-input" />
                <button class="login-btn" onclick="handleLogin()">
                    <span>Login</span>
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="form-container">
            <div class="form-header">
                <h2 class="form-title">Patient Assessment Form</h2>
                <p class="form-description">Complete the comprehensive cardiac risk evaluation below. All parameters are required for accurate assessment.</p>
            </div>

            <form id="heartForm">
                <div class="form-grid">
                    <div class="form-group age" style="visibility: hidden;">
                        <label for="age"><span class="label-icon">üë§</span> Age</label>
                        <input type="number" id="age" name="age" min="0" max="100" class="modern-input" />
                        <div class="error-message" id="age-error"></div>
                    </div>

                    <div class="form-group sex" style="visibility: hidden;">
                        <label><span class="label-icon">‚öß</span> Sex</label>
                        <div class="radio-group modern-radio">
                            <label class="radio-card">
                                <input type="radio" id="female" name="sex" value="0" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">Female</span></span>
                            </label>
                            <label class="radio-card">
                                <input type="radio" id="male" name="sex" value="1" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">Male</span></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group cp" style="visibility: hidden;">
                        <label for="cp"><span class="label-icon">üíî</span> Chest Pain Type</label>
                        <select id="cp" name="cp" class="modern-select">
                            <option value="">Select type...</option>
                            <option value="0">Typical angina</option>
                            <option value="1">Atypical angina</option>
                            <option value="2">Non-anginal pain</option>
                            <option value="3">Asymptomatic</option>
                        </select>
                    </div>

                    <div class="form-group trestbps" style="visibility: hidden;">
                        <label for="trestbps"><span class="label-icon">ü©∫</span> Resting Blood Pressure <span class="label-range">(94-200 mmHg)</span></label>
                        <input type="number" id="trestbps" name="trestbps" min="94" max="200" class="modern-input" />
                    </div>

                    <div class="form-group chol" style="visibility: hidden;">
                        <label for="chol"><span class="label-icon">üß™</span> Serum Cholesterol <span class="label-range">(126-564 mg/dl)</span></label>
                        <input type="number" id="chol" name="chol" min="126" max="564" class="modern-input" />
                    </div>

                    <div class="form-group fbs" style="visibility: hidden;">
                        <label><span class="label-icon">üç¨</span> Fasting Blood Sugar <span class="label-range">(>120 mg/dl)</span></label>
                        <div class="radio-group modern-radio">
                            <label class="radio-card">
                                <input type="radio" id="fbs-no" name="fbs" value="0" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">No</span></span>
                            </label>
                            <label class="radio-card">
                                <input type="radio" id="fbs-yes" name="fbs" value="1" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">Yes</span></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group restecg" style="visibility: hidden;">
                        <label for="restecg"><span class="label-icon">üìä</span> Resting ECG Results</label>
                        <select id="restecg" name="restecg" class="modern-select">
                            <option value="">Select result...</option>
                            <option value="0">Normal</option>
                            <option value="1">Mild abnormality</option>
                            <option value="2">Significant abnormality</option>
                        </select>
                    </div>

                    <div class="form-group thalach" style="visibility: hidden;">
                        <label for="thalach"><span class="label-icon">üíó</span> Max Heart Rate <span class="label-range">(71-202 bpm)</span></label>
                        <input type="number" id="thalach" name="thalach" min="71" max="202" class="modern-input" />
                    </div>

                    <div class="form-group exang" style="visibility: hidden;">
                        <label><span class="label-icon">üèÉ</span> Exercise Induced Angina</label>
                        <div class="radio-group modern-radio">
                            <label class="radio-card">
                                <input type="radio" id="exang-no" name="exang" value="0" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">No</span></span>
                            </label>
                            <label class="radio-card">
                                <input type="radio" id="exang-yes" name="exang" value="1" />
                                <span class="radio-content"><span class="radio-check"></span><span class="radio-label">Yes</span></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group oldpeak" style="visibility: hidden;">
                        <label for="oldpeak"><span class="label-icon">üìâ</span> ST Depression <span class="label-range">(0.0-6.2)</span></label>
                        <input type="number" id="oldpeak" name="oldpeak" min="0" max="6.2" step="0.1" class="modern-input" />
                    </div>

                    <div class="form-group slope" style="visibility: hidden;">
                        <label for="slope"><span class="label-icon">üìà</span> ST Segment Slope</label>
                        <select id="slope" name="slope" class="modern-select">
                            <option value="">Select slope...</option>
                            <option value="0">Downsloping</option>
                            <option value="1">Flat</option>
                            <option value="2">Upsloping</option>
                        </select>
                    </div>

                    <div class="form-group ca" style="visibility: hidden;">
                        <label for="ca"><span class="label-icon">üî¨</span> Major Vessels <span class="label-range">(0-3)</span></label>
                        <input type="number" id="ca" name="ca" min="0" max="3" class="modern-input" />
                    </div>

                    <div class="form-group full-width thal" style="visibility: hidden;">
                        <label for="thal"><span class="label-icon">üß¨</span> Thalassemia Status</label>
                        <select id="thal" name="thal" class="modern-select">
                            <option value="">Select status...</option>
                            <option value="0">Unknown</option>
                            <option value="1">Normal</option>
                            <option value="2">Fixed defect</option>
                            <option value="3">Reversible defect</option>
                        </select>
                    </div>
                </div> <div class="form-group full-width">
                    <label for="modelSelect"><span class="label-icon">ü§ñ</span> Select Prediction Model</label>
                    <select id="modelSelect" name="model" required class="modern-select">
                        <option value="">Choose prediction model...</option>
                        {% for model,feature in all_model.items() %}
                        <option value="{{ model }}">{{ model }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="button-group">
                    <button type="submit" class="submit-btn">
                        <span>Analyze Risk</span>
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7" />
                        </svg>
                    </button>
                    <button type="button" class="reset-btn" onclick="resetForm()">
                        <span>Reset Form</span>
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M3 21v-5h5" />
                        </svg>
                    </button>
                </div>
            </form>

            <div class="result-section" id="resultSection">
                <div class="result-icon" id="resultIcon"></div>
                <h3 class="result-title" id="resultTitle"></h3>
                <p class="result-text" id="resultText"></p>
                <div class="result-score">
                    <span class="score-label">Risk Score</span>
                    <span class="score-value" id="scoreValue"></span>
                </div>
            </div>

            <div class="feedback-section" id="feedbackSection" style="visibility: hidden;">
                <h4 class="feedback-title">Was this prediction accurate?</h4>
                <div class="feedback-buttons">
                    <button class="feedback-btn correct" id="correctpre"><span>‚úì</span> Prediction is Correct</button>
                    <button class="feedback-btn incorrect" onclick="showCorrectPredictionForm()"><span>‚úó</span> Prediction is Incorrect</button>
                </div>
                <form class="correct-prediction-form" id="correctPredictionForm">
                    <label for="correctPrediction">What is the correct diagnosis?</label>
                    <input type="text" name="true_target_value" id="true_target_value" class="modern-input">
                    <button class="submit-btn" style="margin-top: 12px" >Submit Feedback</button>
                </form>
                <div class="feedback-success" id="feedbackSuccess">
                    <span class="success-icon">‚úì</span> Thank you for your feedback!
                </div>
            </div>

            <div class="disclaimer">
                <svg class="disclaimer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" /><path d="M12 16v-4M12 8h.01" />
                </svg>
                <div>
                    <strong>Medical Disclaimer</strong>
                    <p>This tool provides risk assessment for educational purposes only and should not replace professional medical advice.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var true_target;
        const scoreValue = document.getElementById("scoreValue");
        const correctPredictionForm = document.getElementById("correctPredictionForm")
        function submitFeedback(e){
          const modelElem = document.getElementById("modelSelect")

          data = getPatientData();
          data["pred_target"]=scoreValue.innerText;
          data["target"]=true_target;
          data["model"] = modelElem.value
          data = JSON.stringify(data)
          fetch("/feedback",{
            method:"POST",
            headers:{
              'Content-Type': 'application/json',
            },
            body:data
          })

        }

        document.getElementById("correctpre").addEventListener("click",(e)=>{
          true_target=scoreValue.innerText;
          submitFeedback();
          const resultSection = document.getElementById("resultSection");
          resultSection.classList.remove("show");
        })

        correctPredictionForm.addEventListener("submit",(e)=>{
          e.preventDefault();
          true_target = document.getElementById("true_target_value").innerText;
          submitFeedback();
          correctPredictionForm.classList.remove("show");
          const resultSection = document.getElementById("resultSection");
          resultSection.classList.remove("show");
        })

        function showCorrectPredictionForm(e){

          correctPredictionForm.classList.add("show");
          
        }


        function handleLogin() {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const form = new FormData();
            form.append("username", username);
            form.append("password", password);
            fetch("/login", {
                method: "POST",
                body: form
            }).then(res => { if(res.url) window.location.href = res.url; });
        }

        const heartForm = document.getElementById("heartForm");
        heartForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const formData = new FormData(heartForm);
            const data = Object.fromEntries(formData);
            fetch("/checkheart", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.json())
              .then(data => displayResult(data["result"]));
        });

        const all_model = {{ all_model|tojson }};
        var currentFeature;
        const modelSelect = document.getElementById("modelSelect");

        function hideAllCurrentFeature() {
            if (!currentFeature) return;
            currentFeature.forEach((elem) => {
                const ele = document.getElementsByClassName(elem[0])[0];
                if(ele) ele.style.visibility = "hidden";
            });
        }

        modelSelect.addEventListener("change", (e) => {
            hideAllCurrentFeature();
            currentFeature = all_model[modelSelect.value];
            if (currentFeature) {
                currentFeature.forEach((elem) => {
                    const ele = document.getElementsByClassName(elem[0])[0];
                    if(ele) ele.style.visibility = "visible";
                });
            }
        });

        function resetForm() {
            heartForm.reset();
            document.getElementById("resultSection").classList.remove("show");
            document.getElementById("feedbackSection").style.visibility = "hidden";
            hideAllCurrentFeature();
            currentFeature = null;
        }

        function displayResult(score) {
            const resultSection = document.getElementById("resultSection");
            resultSection.classList.add("show");
            scoreValue.textContent = `${score}/25`;
            document.getElementById("feedbackSection").style.visibility = "visible";
            resultSection.scrollIntoView({ behavior: "smooth" });
        }
        function getPatientData() {
    // List of IDs matching your database columns
    const fields = [
        'age', 'sex', 'fbs', 'restecg', 'exang', 
        'oldpeak', 'cp', 'chol', 'slope', 'ca', 
        'thal', 'trestbps','thalach'
    ];

    const data = {};

    fields.forEach(field => {
        const element = document.getElementById(field);
        
        if (element) {
            // Logic for handling Radio buttons vs Input/Select
            if (element.type === 'radio') {
                const checkedRadio = document.querySelector(`input[name="${field}"]:checked`);
                data[field] = checkedRadio ? checkedRadio.value : null;
            } else {
                data[field] = element.value;
            }
        }
    });

    return data;
}
    </script>
</body>
</html>